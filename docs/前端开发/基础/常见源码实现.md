---
title: é¢è¯•--å¸¸è§æºç å®ç°
date: 2018-04-10
tags: js
---

ğŸ¯---ç›®æ ‡---ğŸ¯

- call apply
- bind
- instansof
- new
- ES5/ES6 åŒå‘ç»‘å®š
- co
- æ·±æ‹·è´
- å‡½æ•°æŸ¯é‡ŒåŒ–
- é˜²æŠ– && èŠ‚æµ
- Promise 
- async/await

## call && apply

```js
fn.call(obj, arg1, arg2...)
fn.apply(obj, [argArray])
```
call
- å°†å‡½æ•°è®¾ä¸ºä¼ å…¥å‚æ•°çš„å±æ€§
- æŒ‡å®šthis
- å¦‚æœä¸ä¼ å…¥å‚æ•°æˆ–è€…å‚æ•°ä¸ºnull, é»˜è®¤æŒ‡å‘ä¸ºwindow / global
- åˆ é™¤å‚æ•°ä¸Šçš„å±æ€§
```js
Function.prototype.call = function (context) {
/** å¦‚æœç¬¬ä¸€ä¸ªå‚æ•°ä¼ å…¥çš„æ˜¯ null æˆ–è€…æ˜¯ undefined, é‚£ä¹ˆæŒ‡å‘thisæŒ‡å‘ window/global */ 
/** å¦‚æœç¬¬ä¸€ä¸ªå‚æ•°ä¼ å…¥çš„ä¸æ˜¯nullæˆ–è€…æ˜¯undefined, é‚£ä¹ˆå¿…é¡»æ˜¯ä¸€ä¸ªå¯¹è±¡ */ 
    if (!context) { //contextä¸ºnullæˆ–è€…æ˜¯undefined 
        context = typeof window === 'undefined' ? global : window; 
    } 
    context.fn = this;  //thisæŒ‡å‘çš„æ˜¯å½“å‰çš„å‡½æ•°(Functionçš„å®ä¾‹) 
    let rest = [...arguments].slice(1);   //è·å–é™¤äº†thisæŒ‡å‘å¯¹è±¡ä»¥å¤–çš„å‚æ•°, ç©ºæ•°ç»„sliceåè¿”å›çš„ä»ç„¶æ˜¯ç©ºæ•°ç»„ 
    let result = context.fn(...rest);  //éšå¼ç»‘å®š,å½“å‰å‡½æ•°çš„thisæŒ‡å‘äº†context. 
    delete context.fn; 
    return result; 
} 
//æµ‹è¯•ä»£ç  
var foo = { 
    name: 'Selina' 
} 
var name = 'Chirs'; 
function bar(job, age) { 
    console.log(this.name); 
    console.log(job, age); 
} 
bar.call(foo, 'programmer', 20); // Selina programmer 20 
bar.call(null, 'teacher', 25); // æµè§ˆå™¨ç¯å¢ƒ: Chirs teacher 25; node ç¯å¢ƒ: undefined teacher 25
```


apply
- applyå®ç°ä¸callç±»ä¼¼ï¼Œåªæ˜¯ç¬¬äºŒä¸ªå‚æ•°æ˜¯æ•°ç»„æˆ–è€…ç±»æ•°ç»„

```js
 Function.prototype.apply = function (context, rest) {
    if (!context) {
        //contextä¸ºnullæˆ–è€…æ˜¯undefinedæ—¶,è®¾ç½®é»˜è®¤å€¼
        context = typeof window === 'undefined' ? global : window;
    }
    context.fn = this;
    let result;
    if(rest === undefined || rest === null) {
        //undefined æˆ–è€… æ˜¯ null ä¸æ˜¯ Iterator å¯¹è±¡ï¼Œä¸èƒ½è¢« ...
        result = context.fn(rest);
    }else if(typeof rest === 'object') {
        result = context.fn(...rest);
    }
    delete context.fn;
    return result;
}

// æµ‹è¯•
var foo = {
    name: 'Selina'
}
var name = 'Chirs';
function bar(job, age) {
    console.log(this.name);
    console.log(job, age);
}
bar.apply(foo, ['programmer', 20]);
// Selina programmer 20
bar.apply(null, ['teacher', 25]);
// æµè§ˆå™¨ç¯å¢ƒ: Chirs programmer 20; node ç¯å¢ƒ: undefined teacher 25
```


## bind
 bind å’Œ call/apply æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„åŒºåˆ«ï¼Œä¸€ä¸ªå‡½æ•°è¢« call/apply çš„æ—¶å€™ï¼Œä¼šç›´æ¥è°ƒç”¨ï¼Œä½†æ˜¯ bind ä¼šåˆ›å»ºä¸€ä¸ªæ–°å‡½æ•°ã€‚å½“è¿™ä¸ªæ–°å‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œbind() çš„ç¬¬ä¸€ä¸ªå‚æ•°å°†ä½œä¸ºå®ƒè¿è¡Œæ—¶çš„ thisï¼Œä¹‹åçš„ä¸€åºåˆ—å‚æ•°å°†ä¼šåœ¨ä¼ é€’çš„å®å‚å‰ä¼ å…¥ä½œä¸ºå®ƒçš„å‚æ•°ã€‚
```js
 Function.prototype.bind = function(context) {
    if(typeof this !== "function"){
        throw new TypeError("not a function");
    }
    let self = this;
    let args = [...arguments].slice(1);
    function Fn() {};
    Fn.prototype = this.prototype;
    let bound = function() {
        let res = [...args, ...arguments]; //bindä¼ é€’çš„å‚æ•°å’Œå‡½æ•°è°ƒç”¨æ—¶ä¼ é€’çš„å‚æ•°æ‹¼æ¥
        context = this instanceof Fn ? this : context || this;
        return self.apply(context, res);
    }
    //åŸå‹é“¾
    bound.prototype = new Fn();
    return bound;
}

var name = 'Jack';
function person(age, job, gender){
    console.log(this.name , age, job, gender);
}
var o = {name : 'Linda'};
let result = person.bind(o, 22, 'enginner')('female');
```
## instanceof
instanceof
```js
function instance_of(L, R) {//L è¡¨ç¤ºå·¦è¡¨è¾¾å¼ï¼ŒR è¡¨ç¤ºå³è¡¨è¾¾å¼
    var O = R.prototype;
    L = L.__proto__;
    while (true) { 
        if (L === null) 
            return false; 
        if (O === L)  // è¿™é‡Œé‡ç‚¹ï¼šå½“ O ä¸¥æ ¼ç­‰äº L æ—¶ï¼Œè¿”å› true 
            return true; 
        L = L.__proto__; 
    } 
}
```
## new
- åˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡ï¼Œthiså¼•ç”¨è¯¥å¯¹è±¡ // let target = {}
- ç»§æ‰¿äº†å‡½æ•°åŸå‹ // target.proto = func.prototype
- å±æ€§å’Œæ–¹æ³•åŠ å…¥åˆ°thiså¼•ç”¨çš„å¯¹è±¡ä¸­ï¼Œå¹¶æ‰§è¡Œfunc.call(targrt)
- æ–°åˆ›å»ºçš„å¯¹è±¡ç”±thiså¼•ç”¨ï¼Œå¹¶æœ€åéšå¼è¿”å›this. // å¦‚æœfunc.call(target)è¿”å›çš„æ˜¯ä¸ªå¯¹è±¡æˆ–è€…functionå°±è¿”å›ä»–
```js
function new(func) {
	lat target = {};
	target.__proto__ = func.prototype;
	let res = func.call(target);
	if (typeof(res) == "object" && res || typeof(res) == "function") {
		return res;
	}
	return target;
}
```
## åŒå‘ç»‘å®š
Viewå±‚çš„å˜åŒ–èƒ½å®æ—¶è®©æ•°æ®æ¨¡å‹Modelå˜åŒ–ï¼Œè€Œæ•°æ®çš„å˜åŒ–ä¹Ÿèƒ½å®æ—¶æ›´æ–°åˆ°è§†å›¾å±‚
  ### ES5
  Object.defineProperty
  ```html
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta http-equiv="X-UA-Compatible" content="ie=edge" />
        <title>Document</title>
        <script>
        const obj = {
            value: ""
        };

        function onKeyUp(event) {
            obj.value = event.target.value;
        }

        // å¯¹ obj.value è¿›è¡Œæ‹¦æˆª
        Object.defineProperty(obj, "value", {
            get: function() {
                return value;
            },
            set: function(newValue) {
                value = newValue;
                document.querySelector("#value").innerHTML = newValue; // æ›´æ–°è§†å›¾å±‚
                document.querySelector("input").value = newValue; // æ•°æ®æ¨¡å‹æ”¹å˜
            }
        });
        </script>
    </head>
    <body>
        <p>å€¼æ˜¯ï¼š<span id="value"></span></p>
        <input type="text" onkeyup="onKeyUp(event)" />
    </body>
    </html>
  ```
  ### ES6
  éšç€ï¼Œvue3.0 æ”¾å¼ƒæ”¯æŒäº† IE æµè§ˆå™¨ã€‚è€Œä¸”Proxyå…¼å®¹æ€§è¶Šæ¥è¶Šå¥½ï¼Œèƒ½æ”¯æŒ 13 ç§åŠ«æŒæ“ä½œã€‚
  å› æ­¤ï¼Œvue3.0 é€‰æ‹©ä½¿ç”¨Proxyæ¥å®ç°åŒå‘æ•°æ®ç»‘å®šï¼Œè€Œä¸å†ä½¿ç”¨Object.definePropertyã€‚
  ```html
    <!DOCTYPE html>
    <html lang="en">
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <script>
        const obj = {}

        const newObj = new Proxy(obj, {
            get: function(target, key, receiver) {
                return Reflect.get(target, key, receiver)
            },
            set: function(target, key, value, receiver) {
                if(key === 'value') {
                    document.querySelector('#value').innerHTML = value
                    document.querySelector('input').value = value
                }
                return Reflect.set(target, key, value, receiver)
            }
        })

        function onKeyUp(event) {
            newObj.value = event.target.value
        }
    </script>
    </head>
    <body>
    <p>
        å€¼æ˜¯ï¼š<span id="value"></span>
    </p>
    <input type="text" onkeyup="onKeyUp(event)">
    </body>
    </html>
  ```
## co
```js
 function my_co (it) {
    return new Promise((resolve, reject) => {
        function next(data) {
            let {value, done} = it.next(data);
            if(!done) {
                value.then(val => {
                    next(val);
                }, reject);
            }else{
                resolve(value);
            }

        }
        next();
    });
}
```
## æ·±æ‹·è´
```js
function deepClone(obj) { //é€’å½’æ‹·è´
    if(obj === null) return null; //null çš„æƒ…å†µ
    if(obj instanceof RegExp) return new RegExp(obj);
    if(obj instanceof Date) return new Date(obj);
    if(typeof obj !== 'object') {
        //å¦‚æœä¸æ˜¯å¤æ‚æ•°æ®ç±»å‹ï¼Œç›´æ¥è¿”å›
        return obj;
    }
    /**
     * å¦‚æœobjæ˜¯æ•°ç»„ï¼Œé‚£ä¹ˆ obj.constructor æ˜¯ [Function: Array]
     * å¦‚æœobjæ˜¯å¯¹è±¡ï¼Œé‚£ä¹ˆ obj.constructor æ˜¯ [Function: Object]
     */
    let t = new obj.constructor();
    for(let key in obj) {
        //å¦‚æœ obj[key] æ˜¯å¤æ‚æ•°æ®ç±»å‹ï¼Œé€’å½’
        t[key] = deepClone(obj[key]);
    }
    return t;
}
```

## å‡½æ•°æŸ¯é‡ŒåŒ–
```js
function curry(fn, args = []) {
    return function(){
        let rest = [...args, ...arguments];
        if (rest.length < fn.length) {
            return curry.call(this,fn,rest);
        }else{
            return fn.apply(this,rest);
        }
    }
}
//test
function sum(a,b,c) {
    return a+b+c;
}
let sumFn = curry(sum);
console.log(sumFn(1)(2)(3)); //6
console.log(sumFn(1)(2, 3)); //6
```
## é˜²æŠ– && èŠ‚æµ
**é˜²æŠ–(debounce): nç§’å†…å‡½æ•°åªä¼šæ‰§è¡Œä¸€æ¬¡ï¼Œå¦‚æœnç§’å†…é«˜é¢‘äº‹ä»¶å†æ¬¡è¢«è§¦å‘ï¼Œåˆ™é‡æ–°è®¡ç®—æ—¶é—´**
```js
/**
*
* æ¯æ¬¡ resize/scroll è§¦å‘ç»Ÿè®¡äº‹ä»¶
* æ–‡æœ¬è¾“å…¥çš„éªŒè¯ï¼ˆè¿ç»­è¾“å…¥æ–‡å­—åå‘é€ AJAX è¯·æ±‚è¿›è¡ŒéªŒè¯ï¼ŒéªŒè¯ä¸€æ¬¡å°±å¥½ï¼‰
*/

function debounce(func, wait, immediate = true) {
    let timer;
    // å»¶è¿Ÿæ‰§è¡Œå‡½æ•°
    const later = (context, args) => setTimeout(() => {
        timer = null;// å€’è®¡æ—¶ç»“æŸ
        if (!immediate) {
            func.apply(context, args);
            //æ‰§è¡Œå›è°ƒ
            context = args = null;
        }
    }, wait);
    let debounced = function (...params) {
        let context = this;
        let args = params;
        if (!timer) {
            timer = later(context, args);
            if (immediate) {
                //ç«‹å³æ‰§è¡Œ
                func.apply(context, args);
            }
        } else {
            clearTimeout(timer);
            //å‡½æ•°åœ¨æ¯ä¸ªç­‰å¾…æ—¶å»¶çš„ç»“æŸè¢«è°ƒç”¨
            timer = later(context, args);
        }
    }
    debounced.cancel = function () {
        clearTimeout(timer);
        timer = null;
    };
    return debounced;
};
```
**èŠ‚æµ(throttle): é«˜é¢‘äº‹ä»¶åœ¨è§„å®šæ—¶é—´å†…åªä¼šæ‰§è¡Œä¸€æ¬¡ï¼Œæ‰§è¡Œä¸€æ¬¡åï¼Œåªæœ‰å¤§äºè®¾å®šçš„æ‰§è¡Œå‘¨æœŸåæ‰ä¼šæ‰§è¡Œç¬¬äºŒæ¬¡ã€‚**
```js
//DOM å…ƒç´ çš„æ‹–æ‹½åŠŸèƒ½å®ç°ï¼ˆmousemoveï¼‰
//å°„å‡»æ¸¸æˆçš„ mousedown/keydown äº‹ä»¶ï¼ˆå•ä½æ—¶é—´åªèƒ½å‘å°„ä¸€é¢—å­å¼¹ï¼‰
//è®¡ç®—é¼ æ ‡ç§»åŠ¨çš„è·ç¦»ï¼ˆmousemoveï¼‰
//Canvas æ¨¡æ‹Ÿç”»æ¿åŠŸèƒ½ï¼ˆmousemoveï¼‰
//æœç´¢è”æƒ³ï¼ˆkeyupï¼‰
//ç›‘å¬æ»šåŠ¨äº‹ä»¶åˆ¤æ–­æ˜¯å¦åˆ°é¡µé¢åº•éƒ¨è‡ªåŠ¨åŠ è½½æ›´å¤šï¼šç»™ scroll åŠ äº† debounce åï¼Œåªæœ‰ç”¨æˆ·åœæ­¢æ»šåŠ¨åï¼Œæ‰ä¼šåˆ¤æ–­æ˜¯å¦åˆ°äº†é¡µé¢åº•éƒ¨ï¼›å¦‚æœæ˜¯ throttle çš„è¯ï¼Œåªè¦é¡µé¢æ»šåŠ¨å°±ä¼šé—´éš”ä¸€æ®µæ—¶é—´åˆ¤æ–­ä¸€æ¬¡

function throttle(func, wait, options) {
    var timeout, context, args, result;
    var previous = 0;
    if (!options) options = {};

    var later = function () {
        previous = options.leading === false ? 0 : Date.now() || new Date().getTime();
        timeout = null;
        result = func.apply(context, args);
        if (!timeout) context = args = null;
    };

    var throttled = function () {
        var now = Date.now() || new Date().getTime();
        if (!previous && options.leading === false) previous = now;
        var remaining = wait - (now - previous);
        context = this;
        args = arguments;
        if (remaining <= 0 || remaining > wait) {
            if (timeout) {
                clearTimeout(timeout);
                timeout = null;
            }
            previous = now;
            result = func.apply(context, args);
            if (!timeout) context = args = null;
        } else if (!timeout && options.trailing !== false) {
            // åˆ¤æ–­æ˜¯å¦è®¾ç½®äº†å®šæ—¶å™¨å’Œ trailing
            timeout = setTimeout(later, remaining);
        }
        return result;
    };

    throttled.cancel = function () {
        clearTimeout(timeout);
        previous = 0;
        timeout = context = args = null;
    };

    return throttled;
};

```

## Promise
**promiseçŠ¶æ€**
- fulfilled
- rejected
- pending

**ä¼˜ç‚¹**
- ä¸€æ—¦çŠ¶æ€æ”¹å˜ï¼Œå°±ä¸ä¼šå†å˜
- å¯ä»¥å°†å¼‚æ­¥æ“ä½œä»¥åŒæ­¥æ“ä½œçš„æµç¨‹è¡¨è¾¾å‡ºæ¥ï¼Œé¿å…äº†å›è°ƒå‡½æ•°

**ç¼ºç‚¹**
- æ— æ³•å–æ¶ˆ promise
- å½“å¤„äºpendingçŠ¶æ€æ—¶ï¼Œæ— æ³•å¾—çŸ¥è¿›å±•åˆ°å“ªä¸€é˜¶æ®µ
```js
/**
 * 1. new Promiseæ—¶ï¼Œéœ€è¦ä¼ é€’ä¸€ä¸ª executor æ‰§è¡Œå™¨ï¼Œæ‰§è¡Œå™¨ç«‹åˆ»æ‰§è¡Œ
 * 2. executor æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯ resolve å’Œ reject
 * 3. promise åªèƒ½ä» pending åˆ° rejected, æˆ–è€…ä» pending åˆ° fulfilled
 * 4. promise çš„çŠ¶æ€ä¸€æ—¦ç¡®è®¤ï¼Œå°±ä¸ä¼šå†æ”¹å˜
 * 5. promise éƒ½æœ‰ then æ–¹æ³•ï¼Œthen æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯ promise æˆåŠŸçš„å›è°ƒ onFulfilled, 
 *      å’Œ promise å¤±è´¥çš„å›è°ƒ onRejected
 * 6. å¦‚æœè°ƒç”¨ then æ—¶ï¼Œpromiseå·²ç»æˆåŠŸï¼Œåˆ™æ‰§è¡Œ onFulfilledï¼Œå¹¶å°†promiseçš„å€¼ä½œä¸ºå‚æ•°ä¼ é€’è¿›å»ã€‚
 *      å¦‚æœpromiseå·²ç»å¤±è´¥ï¼Œé‚£ä¹ˆæ‰§è¡Œ onRejected, å¹¶å°† promise å¤±è´¥çš„åŸå› ä½œä¸ºå‚æ•°ä¼ é€’è¿›å»ã€‚
 *      å¦‚æœpromiseçš„çŠ¶æ€æ˜¯pendingï¼Œéœ€è¦å°†onFulfilledå’ŒonRejectedå‡½æ•°å­˜æ”¾èµ·æ¥ï¼Œç­‰å¾…çŠ¶æ€ç¡®å®šåï¼Œå†ä¾æ¬¡å°†å¯¹åº”çš„å‡½æ•°æ‰§è¡Œ(å‘å¸ƒè®¢é˜…)
 * 7. then çš„å‚æ•° onFulfilled å’Œ onRejected å¯ä»¥ç¼ºçœ
 * 8. promise å¯ä»¥thenå¤šæ¬¡ï¼Œpromise çš„then æ–¹æ³•è¿”å›ä¸€ä¸ª promise
 * 9. å¦‚æœ then è¿”å›çš„æ˜¯ä¸€ä¸ªç»“æœï¼Œé‚£ä¹ˆå°±ä¼šæŠŠè¿™ä¸ªç»“æœä½œä¸ºå‚æ•°ï¼Œä¼ é€’ç»™ä¸‹ä¸€ä¸ªthençš„æˆåŠŸçš„å›è°ƒ(onFulfilled)
 * 10. å¦‚æœ then ä¸­æŠ›å‡ºäº†å¼‚å¸¸ï¼Œé‚£ä¹ˆå°±ä¼šæŠŠè¿™ä¸ªå¼‚å¸¸ä½œä¸ºå‚æ•°ï¼Œä¼ é€’ç»™ä¸‹ä¸€ä¸ªthençš„å¤±è´¥çš„å›è°ƒ(onRejected)
 * 11.å¦‚æœ then è¿”å›çš„æ˜¯ä¸€ä¸ªpromise,é‚£ä¹ˆéœ€è¦ç­‰è¿™ä¸ªpromiseï¼Œé‚£ä¹ˆä¼šç­‰è¿™ä¸ªpromiseæ‰§è¡Œå®Œï¼Œpromiseå¦‚æœæˆåŠŸï¼Œ
 *   å°±èµ°ä¸‹ä¸€ä¸ªthençš„æˆåŠŸï¼Œå¦‚æœå¤±è´¥ï¼Œå°±èµ°ä¸‹ä¸€ä¸ªthençš„å¤±è´¥
 */

const PENDING = 'pending';
const FULFILLED = 'fulfilled';
const REJECTED = 'rejected';
function Promise(executor) {
    let self = this;
    self.status = PENDING;
    self.onFulfilled = [];//æˆåŠŸçš„å›è°ƒ
    self.onRejected = []; //å¤±è´¥çš„å›è°ƒ
    //PromiseA+ 2.1
    function resolve(value) {
        if (self.status === PENDING) {
            self.status = FULFILLED;
            self.value = value;
            self.onFulfilled.forEach(fn => fn());//PromiseA+ 2.2.6.1
        }
    }

    function reject(reason) {
        if (self.status === PENDING) {
            self.status = REJECTED;
            self.reason = reason;
            self.onRejected.forEach(fn => fn());//PromiseA+ 2.2.6.2
        }
    }

    try {
        executor(resolve, reject);
    } catch (e) {
        reject(e);
    }
}

Promise.prototype.then = function (onFulfilled, onRejected) {
    //PromiseA+ 2.2.1 / PromiseA+ 2.2.5 / PromiseA+ 2.2.7.3 / PromiseA+ 2.2.7.4
    onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : value => value;
    onRejected = typeof onRejected === 'function' ? onRejected : reason => { throw reason };
    let self = this;
    //PromiseA+ 2.2.7
    let promise2 = new Promise((resolve, reject) => {
        if (self.status === FULFILLED) {
            //PromiseA+ 2.2.2
            //PromiseA+ 2.2.4 --- setTimeout
            setTimeout(() => {
                try {
                    //PromiseA+ 2.2.7.1
                    let x = onFulfilled(self.value);
                    resolvePromise(promise2, x, resolve, reject);
                } catch (e) {
                    //PromiseA+ 2.2.7.2
                    reject(e);
                }
            });
        } else if (self.status === REJECTED) {
            //PromiseA+ 2.2.3
            setTimeout(() => {
                try {
                    let x = onRejected(self.reason);
                    resolvePromise(promise2, x, resolve, reject);
                } catch (e) {
                    reject(e);
                }
            });
        } else if (self.status === PENDING) {
            self.onFulfilled.push(() => {
                setTimeout(() => {
                    try {
                        let x = onFulfilled(self.value);
                        resolvePromise(promise2, x, resolve, reject);
                    } catch (e) {
                        reject(e);
                    }
                });
            });
            self.onRejected.push(() => {
                setTimeout(() => {
                    try {
                        let x = onRejected(self.reason);
                        resolvePromise(promise2, x, resolve, reject);
                    } catch (e) {
                        reject(e);
                    }
                });
            });
        }
    });
    return promise2;
}

function resolvePromise(promise2, x, resolve, reject) {
    let self = this;
    //PromiseA+ 2.3.1
    if (promise2 === x) {
        reject(new TypeError('Chaining cycle'));
    }
    if (x && typeof x === 'object' || typeof x === 'function') {
        let used; //PromiseA+2.3.3.3.3 åªèƒ½è°ƒç”¨ä¸€æ¬¡
        try {
            let then = x.then;
            if (typeof then === 'function') {
                //PromiseA+2.3.3
                then.call(x, (y) => {
                    //PromiseA+2.3.3.1
                    if (used) return;
                    used = true;
                    resolvePromise(promise2, y, resolve, reject);
                }, (r) => {
                    //PromiseA+2.3.3.2
                    if (used) return;
                    used = true;
                    reject(r);
                });

            }else{
                //PromiseA+2.3.3.4
                if (used) return;
                used = true;
                resolve(x);
            }
        } catch (e) {
            //PromiseA+ 2.3.3.2
            if (used) return;
            used = true;
            reject(e);
        }
    } else {
        //PromiseA+ 2.3.3.4
        resolve(x);
    }
}

module.exports = Promise;
```
[promiseæºç å®ç°-ç¬¦åˆpromiseA+è§„èŒƒ](https://juejin.im/post/5c88e427f265da2d8d6a1c84#heading-24)

## async/await
```js
function spawn(genF) {
    return new Promise(function(resolve, reject) {
        const gen = genF();
        function step(nextF) {
            let next;
            try {
                next = nextF();
            } catch (e) {
                return reject(e);
            }
            if (next.done) {
                return resolve(next.value);
            }
            Promise.resolve(next.value).then(
                function(v) {
                    step(function() {
                        return gen.next(v);
                    });
                },
                function(e) {
                    step(function() {
                        return gen.throw(e);
                    });
                }
            );
        }
        step(function() {
            return gen.next(undefined);
        });
    });
}
```